<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs>
      
      <!-- MARCADOR (Se activa con un marcador de AR.js) -->
      <a-marker preset="custom" type="pattern" url="marker1.patt" id="marker">

        <!-- Contenedor para ajustar la rotación y posición -->
        <a-entity id="grupo" position="0 0 0" rotation="-90 0 0">
          
          <!-- Imagen central (Pluma) -->
          <a-image id="pluma" src="pen.png" position="0 0 0" scale="0 0 0" opacity="0">
          </a-image>

          <!-- Textura 1 (Izquierda arriba) -->
          <a-image id="textura1" src="ring1.png" position="-1 0.5 0" scale="0 0 0" opacity="0" transparent="true">
          </a-image>

          <!-- Textura 2 (Izquierda abajo) -->
          <a-image id="textura2" src="ring1.png" position="-1 -0.5 0" scale="0 0 0" opacity="0" transparent="true">
          </a-image>

          <!-- Textura 3 (Derecha arriba) -->
          <a-image id="textura3" src="ring1.png" position="1 0.5 0" scale="0 0 0" opacity="0" transparent="true">
          </a-image>

          <!-- Textura 4 (Derecha abajo) -->
          <a-image id="textura4" src="ring1.png" position="1 -0.5 0" scale="0 0 0" opacity="0" transparent="true">
          </a-image>

        </a-entity>

      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Obtener referencias a las imágenes
      const pluma = document.querySelector("#pluma");
      const texturas = [
        document.querySelector("#textura1"),
        document.querySelector("#textura2"),
        document.querySelector("#textura3"),
        document.querySelector("#textura4"),
      ];

      // Función para limpiar animaciones anteriores
      function limpiarAnimaciones(imagen) {
        imagen.removeAttribute("animation__scale");
        imagen.removeAttribute("animation__opacity");
        imagen.removeAttribute("animation__rotation"); // Limpiar animación de rotación
      }

      // Función para animar una imagen con efecto de gelatina
      function animarGelatina(imagen, callback) {
        // Limpiar animaciones anteriores
        limpiarAnimaciones(imagen);

        // Escala inicial (0) y opacidad (0)
        imagen.setAttribute("scale", "0 0 0");
        imagen.setAttribute("opacity", "0");

        // Animación de escala (efecto de gelatina)
        imagen.setAttribute("animation__scale", {
          property: "scale",
          to: "1.2 1.2 1",
          dur: 500,
          easing: "easeOutElastic",
        });

        // Animación de opacidad
        imagen.setAttribute("animation__opacity", {
          property: "opacity",
          to: "1",
          dur: 500,
        });

        // Reducir la escala después del efecto de gelatina
        setTimeout(() => {
          imagen.setAttribute("animation__scale", {
            property: "scale",
            to: "1 1 1",
            dur: 300,
            easing: "easeOutQuad",
          });
        }, 500);

        // Llamar al callback cuando termine la animación
        setTimeout(callback, 800);
      }

      // Función para iniciar la rotación continua
      function iniciarRotacion(imagen) {
        imagen.setAttribute("animation__rotation", {
          property: "rotation",
          to: "0 360 0", // Rotación completa en el eje Y
          dur: 2000, // Duración de la rotación (2 segundos)
          loop: true, // Repetir indefinidamente
          easing: "linear", // Movimiento uniforme
        });
      }

      // Función para iniciar la secuencia de animaciones
      function iniciarSecuencia() {
        // Animar la pluma primero
        animarGelatina(pluma, () => {
          // Luego animar las texturas en secuencia
          let index = 0;
          function animarSiguiente() {
            if (index >= texturas.length) return; // Terminar si no hay más texturas
            animarGelatina(texturas[index], () => {
              // Iniciar rotación después de la animación de gelatina
              iniciarRotacion(texturas[index]);
              animarSiguiente(); // Pasar a la siguiente textura
            });
            index++;
          }
          animarSiguiente(); // Comenzar con la primera textura
        });
      }

      // Evento cuando se detecta el marcador
      document.querySelector("#marker").addEventListener("markerFound", () => {
        console.log("Marcador detectado"); // Debug
        iniciarSecuencia(); // Iniciar la secuencia de animaciones
      });

      // Evento cuando se pierde el marcador
      document.querySelector("#marker").addEventListener("markerLost", () => {
        console.log("Marcador perdido"); // Debug

        // Ocultar todas las imágenes y limpiar animaciones
        pluma.setAttribute("opacity", "0");
        pluma.setAttribute("scale", "0 0 0");
        limpiarAnimaciones(pluma);

        texturas.forEach(textura => {
          textura.setAttribute("opacity", "0");
          textura.setAttribute("scale", "0 0 0");
          limpiarAnimaciones(textura);
        });
      });
    </script>
  </body>
</html>
